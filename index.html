<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .value {
            font-size: 3em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .unit {
            font-size: 1em;
            color: #666;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .status.good {
            background: #4ade80;
            color: white;
        }
        
        .status.moderate {
            background: #fbbf24;
            color: white;
        }
        
        .status.poor {
            background: #ef4444;
            color: white;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            height: 400px;
        }
        
        .floor-plan {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .floor-plan h3 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .room-layout {
            position: relative;
            width: 100%;
            height: 400px;
            background: #f3f4f6;
            border: 2px solid #667eea;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .room {
            position: absolute;
            border: 2px solid #9ca3af;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #4b5563;
        }
        
        .sensor-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            animation: pulse 2s infinite;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .timestamp {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 1.1em;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.5em;
            padding: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Indoor Air Quality Monitoring</h1>
        
        <div id="loading" class="loading">Loading data from Firebase...</div>
        
        <div id="content" style="display: none;">
            <!-- Sensor Cards -->
            <div class="dashboard">
                <div class="card">
                    <h3>üå´Ô∏è TVOC (Total VOC)</h3>
                    <div class="value" id="tvoc-value">--</div>
                    <div class="unit">ppb</div>
                    <span class="status" id="tvoc-status">--</span>
                </div>
                
                <div class="card">
                    <h3>üí® eCO2 (Carbon Dioxide)</h3>
                    <div class="value" id="eco2-value">--</div>
                    <div class="unit">ppm</div>
                    <span class="status" id="eco2-status">--</span>
                </div>
                
                <div class="card">
                    <h3>‚ö° H2 (Hydrogen)</h3>
                    <div class="value" id="h2-value">--</div>
                    <div class="unit">ppm</div>
                    <span class="status" id="h2-status">--</span>
                </div>
                
                <div class="card">
                    <h3>üç∑ Ethanol</h3>
                    <div class="value" id="ethanol-value">--</div>
                    <div class="unit">ppm</div>
                    <span class="status" id="ethanol-status">--</span>
                </div>
            </div>
            
            <!-- Graph -->
            <div class="chart-container">
                <canvas id="airQualityChart"></canvas>
            </div>
            
            <!-- Floor Plan -->
            <div class="floor-plan">
                <h3>üìç Sensor Location - Floor Plan</h3>
                <div class="room-layout">
                    <!-- Living Room -->
                    <div class="room" style="left: 10px; top: 10px; width: 45%; height: 45%;">
                        Living Room
                    </div>
                    
                    <!-- Kitchen -->
                    <div class="room" style="right: 10px; top: 10px; width: 45%; height: 45%;">
                        Kitchen
                    </div>
                    
                    <!-- Bedroom -->
                    <div class="room" style="left: 10px; bottom: 10px; width: 45%; height: 45%;">
                        Bedroom
                    </div>
                    
                    <!-- Bathroom -->
                    <div class="room" style="right: 10px; bottom: 10px; width: 45%; height: 45%;">
                        Bathroom
                    </div>
                    
                    <!-- M5Stack Sensor Marker (You can drag this!) -->
                    <div class="sensor-marker" id="sensor" style="left: 25%; top: 25%;" title="M5Stack Sensor">
                        üì°
                    </div>
                </div>
                <p style="text-align: center; margin-top: 15px; color: #666;">
                    ‚¨ÜÔ∏è Drag the red sensor marker to show where your M5Stack is located
                </p>
            </div>
            
            <div class="timestamp" id="timestamp">Last updated: --</div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const FIREBASE_URL = "https://m5-project-852d2-default-rtdb.asia-southeast1.firebasedatabase.app/LiveReadings.json?auth=aQt4Qmr8CJlpIXaNvSU2ssErAqXrFyZOZhNtXv3M";
        const HISTORY_URL = "https://m5-project-852d2-default-rtdb.asia-southeast1.firebasedatabase.app/m5stack_core_01.json?auth=aQt4Qmr8CJlpIXaNvSU2ssErAqXrFyZOZhNtXv3M";
        
        // Chart setup
        let chart;
        const maxDataPoints = 20;
        let chartData = {
            labels: [],
            datasets: [
                {
                    label: 'TVOC (ppb)',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'eCO2 (ppm)',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'H2 (ppm)',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                }
            ]
        };
        
        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('airQualityChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'üìä Air Quality Trends (Last 20 Readings)',
                            font: { size: 18 }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Concentration'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    }
                }
            });
        }
        
        // Get air quality status
        function getStatus(type, value) {
            if (type === 'tvoc') {
                if (value < 220) return { text: 'Good', class: 'good' };
                if (value < 660) return { text: 'Moderate', class: 'moderate' };
                return { text: 'Poor', class: 'poor' };
            } else if (type === 'eco2') {
                if (value < 600) return { text: 'Good', class: 'good' };
                if (value < 1000) return { text: 'Moderate', class: 'moderate' };
                return { text: 'Poor', class: 'poor' };
            }
            return { text: 'N/A', class: 'moderate' };
        }
        
        // Update display with live data
        function updateDisplay(data) {
            document.getElementById('tvoc-value').textContent = data.tvoc || '--';
            document.getElementById('eco2-value').textContent = data.eco2 || '--';
            document.getElementById('h2-value').textContent = data.h2 || '--';
            document.getElementById('ethanol-value').textContent = data.ethanol || '--';
            
            // Update status
            const tvocStatus = getStatus('tvoc', data.tvoc);
            document.getElementById('tvoc-status').textContent = tvocStatus.text;
            document.getElementById('tvoc-status').className = 'status ' + tvocStatus.class;
            
            const eco2Status = getStatus('eco2', data.eco2);
            document.getElementById('eco2-status').textContent = eco2Status.text;
            document.getElementById('eco2-status').className = 'status ' + eco2Status.class;
            
            document.getElementById('h2-status').textContent = 'Monitoring';
            document.getElementById('h2-status').className = 'status moderate';
            
            document.getElementById('ethanol-status').textContent = 'Monitoring';
            document.getElementById('ethanol-status').className = 'status moderate';
            
            // Update timestamp
            document.getElementById('timestamp').textContent = 
                'Last updated: ' + (data.timestamp || new Date().toLocaleString());
        }
        
        // Update chart with new data
        function updateChart(data) {
            const time = new Date().toLocaleTimeString();
            
            chartData.labels.push(time);
            chartData.datasets[0].data.push(data.tvoc || 0);
            chartData.datasets[1].data.push(data.eco2 || 0);
            chartData.datasets[2].data.push(data.h2 ? data.h2 / 100 : 0); // Scale down H2
            
            // Keep only last 20 data points
            if (chartData.labels.length > maxDataPoints) {
                chartData.labels.shift();
                chartData.datasets.forEach(dataset => dataset.data.shift());
            }
            
            chart.update();
        }
        
        // Fetch data from Firebase
        async function fetchData() {
            try {
                const response = await fetch(FIREBASE_URL);
                const data = await response.json();
                
                if (data) {
                    updateDisplay(data);
                    updateChart(data);
                    
                    // Hide loading, show content
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        // Make sensor marker draggable
        function makeDraggable() {
            const sensor = document.getElementById('sensor');
            const layout = document.querySelector('.room-layout');
            let isDragging = false;
            
            sensor.addEventListener('mousedown', (e) => {
                isDragging = true;
                sensor.style.cursor = 'grabbing';
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const rect = layout.getBoundingClientRect();
                    let x = e.clientX - rect.left - 20;
                    let y = e.clientY - rect.top - 20;
                    
                    // Keep within bounds
                    x = Math.max(0, Math.min(x, rect.width - 40));
                    y = Math.max(0, Math.min(y, rect.height - 40));
                    
                    sensor.style.left = x + 'px';
                    sensor.style.top = y + 'px';
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
                sensor.style.cursor = 'pointer';
            });
        }
        
        // Initialize everything
        window.onload = () => {
            initChart();
            makeDraggable();
            fetchData();
            
            // Refresh data every 3 seconds
            setInterval(fetchData, 3000);
        };
    </script>
</body>
</html>
