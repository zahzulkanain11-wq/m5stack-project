<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .value {
            font-size: 3em;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        
        .unit {
            font-size: 1em;
            color: #666;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }
        
        .status.good {
            background: #4ade80;
            color: white;
        }
        
        .status.moderate {
            background: #fbbf24;
            color: white;
        }
        
        .status.poor {
            background: #ef4444;
            color: white;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            height: 400px;
        }
        
        .floor-plan {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .floor-plan h3 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .room-layout {
            position: relative;
            width: 100%;
            height: 400px;
            background: #f3f4f6;
            border: 2px solid #667eea;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .room {
            position: absolute;
            border: 2px solid #9ca3af;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #4b5563;
        }
        
        .sensor-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            background: #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            animation: pulse 2s infinite;
            cursor: pointer;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }
        
        .timestamp {
            text-align: center;
            color: white;
            margin-top: 20px;
            font-size: 1.1em;
        }
        
        .loading {
            text-align: center;
            color: white;
            font-size: 1.5em;
            padding: 50px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¢ Indoor Air Quality Monitoring</h1>
        
        <div id="loading" class="loading">Loading data from Firebase...</div>
        
        <div id="content" style="display: none;">
            <!-- Sensor Cards -->
            <div class="dashboard">
                <div class="card">
                    <h3>üå´Ô∏è TVOC (Total VOC)</h3>
                    <div class="value" id="tvoc-value">--</div>
                    <div class="unit">ppb</div>
                    <span class="status" id="tvoc-status">--</span>
                </div>
                
                <div class="card">
                    <h3>üí® eCO2 (Carbon Dioxide)</h3>
                    <div class="value" id="eco2-value">--</div>
                    <div class="unit">ppm</div>
                    <span class="status" id="eco2-status">--</span>
                </div>
                
                <div class="card">
                    <h3>‚ö° H2 (Hydrogen)</h3>
                    <div class="value" id="h2-value">--</div>
                    <div class="unit">ppm</div>
                    <span class="status" id="h2-status">--</span>
                </div>
                
                <div class="card">
                    <h3>üç∑ Ethanol</h3>
                    <div class="value" id="ethanol-value">--</div>
                    <div class="unit">ppm</div>
                    <span class="status" id="ethanol-status">--</span>
                </div>
            </div>
            
            <!-- Graph -->
            <div class="chart-container">
                <canvas id="airQualityChart"></canvas>
            </div>
            
            <!-- 3D Room Visualization and Heat Map -->
            <div class="floor-plan">
                <h3 style="text-align: center;">üìç Room Sensor Localization (3D) & Gas Leak Detection</h3>
                <div style="display: flex; gap: 30px; justify-content: center; align-items: center; flex-wrap: wrap;">
                    <!-- 3D Room -->
                    <div style="flex: 1; min-width: 400px;">
                        <canvas id="room3d" width="500" height="500"></canvas>
                        <div style="text-align: center; margin-top: 15px;">
                            <button onclick="rotateLeft()" style="padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">‚¨ÖÔ∏è Rotate Left</button>
                            <button onclick="rotateRight()" style="padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">‚û°Ô∏è Rotate Right</button>
                            <button onclick="resetView()" style="padding: 10px 20px; margin: 5px; background: #764ba2; color: white; border: none; border-radius: 5px; cursor: pointer;">üîÑ Reset View</button>
                        </div>
                    </div>
                    
                    <!-- Heat Map Grid -->
                    <div style="flex: 1; min-width: 400px;">
                        <canvas id="heatmap" width="500" height="500"></canvas>
                        <div style="text-align: center; margin-top: 15px;">
                            <div style="display: inline-flex; align-items: center; gap: 10px; padding: 10px; background: #f3f4f6; border-radius: 10px;">
                                <span style="font-weight: bold;">Gas Concentration:</span>
                                <div style="display: flex; gap: 5px;">
                                    <div style="width: 30px; height: 20px; background: #1e3a8a;"></div>
                                    <span>Low</span>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <div style="width: 30px; height: 20px; background: #22c55e;"></div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <div style="width: 30px; height: 20px; background: #eab308;"></div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    <div style="width: 30px; height: 20px; background: #ef4444;"></div>
                                    <span>High</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <p style="text-align: center; margin-top: 10px; color: #666;">
                    üéÆ Left: 3D sensor positions | Right: Real-time gas leak detection heat map (6√ó6 grid)
                </p>
            </div>
            
            <div class="timestamp" id="timestamp">Last updated: --</div>
        </div>
    </div>

    <script>
        // ============================================
        // FIREBASE CONFIGURATION
        // ============================================
        const FIREBASE_URL = "https://m5-project-852d2-default-rtdb.asia-southeast1.firebasedatabase.app/LiveReadings.json?auth=aQt4Qmr8CJlpIXaNvSU2ssErAqXrFyZOZhNtXv3M";
        const HISTORY_URL = "https://m5-project-852d2-default-rtdb.asia-southeast1.firebasedatabase.app/m5stack_core_01.json?auth=aQt4Qmr8CJlpIXaNvSU2ssErAqXrFyZOZhNtXv3M";
        
        // Chart setup
        let chart;
        const maxDataPoints = 20;
        let chartData = {
            labels: [],
            datasets: [
                {
                    label: 'TVOC (ppb)',
                    data: [],
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239, 68, 68, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'eCO2 (ppm)',
                    data: [],
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4
                },
                {
                    label: 'H2 (ppm)',
                    data: [],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4
                }
            ]
        };
        
        // Initialize chart
        function initChart() {
            const ctx = document.getElementById('airQualityChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'üìä Air Quality Trends (Last 20 Readings)',
                            font: { size: 18 }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Concentration'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    }
                }
            });
        }
        
        // Get air quality status
        function getStatus(type, value) {
            if (type === 'tvoc') {
                if (value < 220) return { text: 'Good', class: 'good' };
                if (value < 660) return { text: 'Moderate', class: 'moderate' };
                return { text: 'Poor', class: 'poor' };
            } else if (type === 'eco2') {
                if (value < 600) return { text: 'Good', class: 'good' };
                if (value < 1000) return { text: 'Moderate', class: 'moderate' };
                return { text: 'Poor', class: 'poor' };
            }
            return { text: 'N/A', class: 'moderate' };
        }
        
        // Update display with live data
        function updateDisplay(data) {
            document.getElementById('tvoc-value').textContent = data.tvoc || '--';
            document.getElementById('eco2-value').textContent = data.eco2 || '--';
            document.getElementById('h2-value').textContent = data.h2 || '--';
            document.getElementById('ethanol-value').textContent = data.ethanol || '--';
            
            // Update status
            const tvocStatus = getStatus('tvoc', data.tvoc);
            document.getElementById('tvoc-status').textContent = tvocStatus.text;
            document.getElementById('tvoc-status').className = 'status ' + tvocStatus.class;
            
            const eco2Status = getStatus('eco2', data.eco2);
            document.getElementById('eco2-status').textContent = eco2Status.text;
            document.getElementById('eco2-status').className = 'status ' + eco2Status.class;
            
            document.getElementById('h2-status').textContent = 'Monitoring';
            document.getElementById('h2-status').className = 'status moderate';
            
            document.getElementById('ethanol-status').textContent = 'Monitoring';
            document.getElementById('ethanol-status').className = 'status moderate';
            
            // Update timestamp
            document.getElementById('timestamp').textContent = 
                'Last updated: ' + (data.timestamp || new Date().toLocaleString());
        }
        
        // Update chart with new data
        function updateChart(data) {
            const time = new Date().toLocaleTimeString();
            
            chartData.labels.push(time);
            chartData.datasets[0].data.push(data.tvoc || 0);
            chartData.datasets[1].data.push(data.eco2 || 0);
            chartData.datasets[2].data.push(data.h2 ? data.h2 / 100 : 0); // Scale down H2
            
            // Keep only last 20 data points
            if (chartData.labels.length > maxDataPoints) {
                chartData.labels.shift();
                chartData.datasets.forEach(dataset => dataset.data.shift());
            }
            
            chart.update();
        }
        
        // Fetch data from Firebase
        async function fetchData() {
            try {
                const response = await fetch(FIREBASE_URL);
                const data = await response.json();
                
                if (data) {
                    updateDisplay(data);
                    updateChart(data);
                    updateGasData(data.tvoc); // Update heat map with TVOC data
                    drawHeatMap();
                    
                    // Hide loading, show content
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('content').style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }
        
        // 3D Room Visualization
        let rotationAngle = 0;
        const canvas = document.getElementById('room3d');
        const ctx = canvas.getContext('2d');
        
        // Sensor positions in 3D space (12 sensors like your image)
        const sensors = [
            // Outer cube corners
            {x: -150, y: -100, z: -150, active: false},
            {x: 0, y: -100, z: -150, active: false},
            {x: 150, y: -100, z: -150, active: false},
            {x: -150, y: -100, z: 0, active: false},
            {x: 150, y: -100, z: 0, active: false},
            {x: -150, y: -100, z: 150, active: false},
            {x: 0, y: -100, z: 150, active: false},
            {x: 150, y: -100, z: 150, active: false},
            // Inner cube corners
            {x: -75, y: 0, z: -75, active: false},
            {x: 75, y: 0, z: -75, active: false},
            {x: -75, y: 0, z: 75, active: false},
            {x: 75, y: 0, z: 75, active: true}, // Active M5Stack sensor
            // Center sensor
            {x: 0, y: 50, z: 0, active: false}
        ];
        
        function project3D(x, y, z, angle) {
            // Rotate around Y axis
            const cos = Math.cos(angle);
            const sin = Math.sin(angle);
            const newX = x * cos - z * sin;
            const newZ = x * sin + z * cos;
            
            // Perspective projection
            const scale = 300 / (300 + newZ);
            return {
                x: canvas.width / 2 + newX * scale,
                y: canvas.height / 2 + y * scale,
                z: newZ,
                scale: scale
            };
        }
        
        function drawRoom() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw title
            ctx.fillStyle = '#667eea';
            ctx.font = 'bold 18px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Room Sensor Localization (3D)', canvas.width / 2, 30);
            
            // Draw outer cube edges
            const outerCorners = [
                {x: -150, y: -100, z: -150},
                {x: 150, y: -100, z: -150},
                {x: 150, y: -100, z: 150},
                {x: -150, y: -100, z: 150}
            ];
            
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < outerCorners.length; i++) {
                const curr = project3D(outerCorners[i].x, outerCorners[i].y, outerCorners[i].z, rotationAngle);
                const next = project3D(outerCorners[(i + 1) % outerCorners.length].x, outerCorners[(i + 1) % outerCorners.length].y, outerCorners[(i + 1) % outerCorners.length].z, rotationAngle);
                if (i === 0) ctx.moveTo(curr.x, curr.y);
                ctx.lineTo(next.x, next.y);
            }
            ctx.stroke();
            
            // Draw inner cube edges
            const innerCorners = [
                {x: -75, y: 0, z: -75},
                {x: 75, y: 0, z: -75},
                {x: 75, y: 0, z: 75},
                {x: -75, y: 0, z: 75}
            ];
            
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1.5;
            ctx.beginPath();
            for (let i = 0; i < innerCorners.length; i++) {
                const curr = project3D(innerCorners[i].x, innerCorners[i].y, innerCorners[i].z, rotationAngle);
                const next = project3D(innerCorners[(i + 1) % innerCorners.length].x, innerCorners[(i + 1) % innerCorners.length].y, innerCorners[(i + 1) % innerCorners.length].z, rotationAngle);
                if (i === 0) ctx.moveTo(curr.x, curr.y);
                ctx.lineTo(next.x, next.y);
            }
            ctx.stroke();
            
            // Connect outer to inner corners
            ctx.strokeStyle = '#999';
            ctx.lineWidth = 1;
            for (let i = 0; i < 4; i++) {
                ctx.beginPath();
                const outer = project3D(outerCorners[i].x, outerCorners[i].y, outerCorners[i].z, rotationAngle);
                const inner = project3D(innerCorners[i].x, innerCorners[i].y, innerCorners[i].z, rotationAngle);
                ctx.moveTo(outer.x, outer.y);
                ctx.lineTo(inner.x, inner.y);
                ctx.stroke();
            }
            
            // Sort sensors by depth for proper rendering
            const projectedSensors = sensors.map(s => ({
                ...s,
                proj: project3D(s.x, s.y, s.z, rotationAngle)
            })).sort((a, b) => a.proj.z - b.proj.z);
            
            // Draw sensors
            projectedSensors.forEach(sensor => {
                const size = 12 * sensor.proj.scale;
                
                if (sensor.active) {
                    // Active M5Stack sensor (red with pulse)
                    ctx.fillStyle = '#ef4444';
                    ctx.strokeStyle = '#dc2626';
                    ctx.lineWidth = 2;
                    
                    // Glow effect
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = '#ef4444';
                } else {
                    // Inactive sensors (gray)
                    ctx.fillStyle = '#6b7280';
                    ctx.strokeStyle = '#4b5563';
                    ctx.lineWidth = 1.5;
                    ctx.shadowBlur = 0;
                }
                
                // Draw sensor
                ctx.beginPath();
                ctx.arc(sensor.proj.x, sensor.proj.y, size, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();
                
                // Reset shadow
                ctx.shadowBlur = 0;
                
                // Draw sensor icon
                ctx.fillStyle = 'white';
                ctx.font = `${size * 1.2}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('üì°', sensor.proj.x, sensor.proj.y);
            });
            
            // Draw label for active sensor
            const activeSensor = projectedSensors.find(s => s.active);
            if (activeSensor) {
                ctx.fillStyle = '#ef4444';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('M5Stack (Active)', activeSensor.proj.x, activeSensor.proj.y + 25);
            }
        }
        
        // Heat Map Visualization
        const heatmapCanvas = document.getElementById('heatmap');
        const heatCtx = heatmapCanvas.getContext('2d');
        const gridSize = 6;
        let gasData = [];
        
        // Initialize gas data with random values
        function initializeGasData() {
            gasData = [];
            for (let i = 0; i < gridSize; i++) {
                gasData[i] = [];
                for (let j = 0; j < gridSize; j++) {
                    gasData[i][j] = 0;
                }
            }
        }
        
        // Simulate gas leak at center (you can replace this with real sensor data)
        function updateGasData(tvocValue) {
            const centerX = 3;
            const centerY = 3;
            
            // Use TVOC value to determine leak intensity
            const leakIntensity = Math.min((tvocValue || 100) / 10, 100);
            
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const distance = Math.sqrt(Math.pow(i - centerX, 2) + Math.pow(j - centerY, 2));
                    // Gaussian distribution from leak source
                    gasData[i][j] = leakIntensity * Math.exp(-distance * distance / 4);
                }
            }
        }
        
        // Get color based on gas concentration
        function getHeatColor(value) {
            // Blue (low) -> Green -> Yellow -> Red (high)
            if (value < 25) {
                const t = value / 25;
                return `rgb(${30 + t * 3}, ${58 + t * 139}, ${138 + t * 0})`;
            } else if (value < 50) {
                const t = (value - 25) / 25;
                return `rgb(${33 + t * 1}, ${197 - t * 116}, ${138 - t * 54})`;
            } else if (value < 75) {
                const t = (value - 50) / 25;
                return `rgb(${34 + t * 200}, ${81 + t * 96}, ${84 - t * 7})`;
            } else {
                const t = (value - 75) / 25;
                return `rgb(${234 + t * 5}, ${177 - t * 109}, ${77 - t * 9})`;
            }
        }
        
        function drawHeatMap() {
            heatCtx.clearRect(0, 0, heatmapCanvas.width, heatmapCanvas.height);
            
            // Draw title
            heatCtx.fillStyle = '#667eea';
            heatCtx.font = 'bold 18px Arial';
            heatCtx.textAlign = 'center';
            heatCtx.fillText('Gas Leak Detection (6√ó6 Grid)', heatmapCanvas.width / 2, 30);
            
            const cellSize = 60;
            const startX = (heatmapCanvas.width - cellSize * gridSize) / 2;
            const startY = 60;
            
            // Draw grid cells with heat colors
            for (let i = 0; i < gridSize; i++) {
                for (let j = 0; j < gridSize; j++) {
                    const x = startX + j * cellSize;
                    const y = startY + i * cellSize;
                    
                    // Draw cell
                    heatCtx.fillStyle = getHeatColor(gasData[i][j]);
                    heatCtx.fillRect(x, y, cellSize - 2, cellSize - 2);
                    
                    // Draw grid lines
                    heatCtx.strokeStyle = '#333';
                    heatCtx.lineWidth = 1;
                    heatCtx.strokeRect(x, y, cellSize - 2, cellSize - 2);
                    
                    // Draw measurement point
                    heatCtx.fillStyle = '#000';
                    heatCtx.beginPath();
                    heatCtx.arc(x + cellSize / 2, y + cellSize / 2, 3, 0, Math.PI * 2);
                    heatCtx.fill();
                }
            }
            
            // Draw leak source marker (star)
            const leakX = startX + 3 * cellSize + cellSize / 2;
            const leakY = startY + 3 * cellSize + cellSize / 2;
            heatCtx.fillStyle = '#fbbf24';
            heatCtx.font = '24px Arial';
            heatCtx.textAlign = 'center';
            heatCtx.textBaseline = 'middle';
            heatCtx.fillText('‚≠ê', leakX, leakY);
            
            // Draw axes labels
            heatCtx.fillStyle = '#333';
            heatCtx.font = 'bold 14px Arial';
            heatCtx.fillText('nz', heatmapCanvas.width / 2, startY + gridSize * cellSize + 30);
            
            heatCtx.save();
            heatCtx.translate(startX - 30, heatmapCanvas.height / 2);
            heatCtx.rotate(-Math.PI / 2);
            heatCtx.fillText('ny', 0, 0);
            heatCtx.restore();
            
            // Draw concentration scale
            heatCtx.fillStyle = '#666';
            heatCtx.font = '12px Arial';
            heatCtx.textAlign = 'right';
            heatCtx.fillText('C (mg/m¬≥)', heatmapCanvas.width - 10, startY + 20);
        }
        
        function rotateLeft() {
            rotationAngle -= 0.2;
            drawRoom();
        }
        
        function rotateRight() {
            rotationAngle += 0.2;
            drawRoom();
        }
        
        function resetView() {
            rotationAngle = 0;
            drawRoom();
        }
        
        // Auto-rotate slowly
        setInterval(() => {
            rotationAngle += 0.005;
            drawRoom();
        }, 50);
        
        // Initialize everything
        window.onload = () => {
            initChart();
            initializeGasData();
            drawRoom();
            drawHeatMap();
            fetchData();
            
            // Refresh data every 3 seconds
            setInterval(fetchData, 3000);
        };
    </script>
</body>
</html>
